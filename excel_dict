Option Explicit

Sub CreateDictionaryFromSelection()
    ' Get the selected range
    Dim rng As Range
    Set rng = Selection
    
    ' Check if a range is selected
    If rng Is Nothing Then
        MsgBox "Please select a range first, then run the macro again.", vbExclamation
        Exit Sub
    End If
    
    ' Create the dictionary
    Dim dict As Object
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' Get headers
    Dim headers As Variant
    headers = Application.Transpose(Application.Transpose(rng.Rows(1).Value))
    
    ' Populate the dictionary
    Dim i As Long
    Dim key As Variant
    Dim rowDict As Object
    Dim deviceCollection As Collection
    
    For i = 2 To rng.Rows.Count ' Start from second row (assuming first row is header)
        key = rng.Cells(i, 1).Value ' First column as key
        
        If Not dict.Exists(key) Then
            Set deviceCollection = New Collection
            dict.Add key, deviceCollection
        End If
        
        Set rowDict = CreateObject("Scripting.Dictionary")
        Dim j As Integer
        For j = 2 To UBound(headers) ' Start from second column
            rowDict.Add headers(j), rng.Cells(i, j).Value
        Next j
        dict(key).Add rowDict
    Next i
    
    ' Output to new sheet
    OutputDictionaryToSheet dict, headers
    
    MsgBox "Dictionary created and output to a new sheet.", vbInformation
End Sub

Sub OutputDictionaryToSheet(dict As Object, headers As Variant)
    ' Add a new worksheet
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Worksheets.Add
    
    ' Write headers
    ws.Cells(1, 1).Value = headers(1) ' First column header
    Dim i As Integer
    For i = 2 To UBound(headers)
        ws.Cells(1, i).Value = headers(i)
    Next i
    
    ' Write data
    Dim row As Long
    row = 2
    Dim key As Variant
    Dim deviceEntry As Object
    Dim deviceCollection As Collection
    
    For Each key In dict.Keys
        Set deviceCollection = dict(key)
        For Each deviceEntry In deviceCollection
            ws.Cells(row, 1).Value = key
            For i = 2 To UBound(headers)
                ws.Cells(row, i).Value = deviceEntry(headers(i))
            Next i
            row = row + 1
        Next deviceEntry
    Next key
    
    ' Auto-fit columns for better readability
    ws.UsedRange.Columns.AutoFit
End Sub
