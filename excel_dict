Option Explicit

Sub CreateDictionaryFromSelection()
    ' Get the selected range
    Dim rng As Range
    Set rng = Selection
    
    ' Check if a range is selected
    If rng Is Nothing Then
        MsgBox "Please select a range first, then run the macro again.", vbExclamation
        Exit Sub
    End If
    
    ' Get headers
    Dim headers As Variant
    headers = Application.Transpose(Application.Transpose(rng.Rows(1).Value))
    
    ' Ask user to choose the key column
    Dim keyColumnName As String
    keyColumnName = InputBox("Enter the column header to use as the dictionary key:" & vbNewLine & _
                             "Options: " & Join(headers, ", "), "Select Key Column")
    
    ' Find the key column index
    Dim keyColumnIndex As Integer
    keyColumnIndex = Application.Match(keyColumnName, headers, 0)
    
    If IsError(keyColumnIndex) Then
        MsgBox "Invalid column name. Please try again.", vbExclamation
        Exit Sub
    End If
    
    ' Create the dictionary
    Dim dict As Object
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' Populate the dictionary
    Dim i As Long
    Dim key As Variant
    Dim rowDict As Object
    
    For i = 2 To rng.Rows.Count ' Start from second row (assuming first row is header)
        key = rng.Cells(i, keyColumnIndex).Value
        
        If Not dict.Exists(key) Then
            Set rowDict = CreateObject("Scripting.Dictionary")
            Dim j As Integer
            For j = 1 To UBound(headers)
                rowDict.Add headers(j), rng.Cells(i, j).Value
            Next j
            dict.Add key, rowDict
        End If
    Next i
    
    ' Output to new sheet
    OutputDictionaryToSheet dict, headers
    
    MsgBox "Dictionary created and output to a new sheet.", vbInformation
End Sub

Sub OutputDictionaryToSheet(dict As Object, headers As Variant)
    ' Add a new worksheet
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Worksheets.Add
    
    ' Write headers
    ws.Cells(1, 1).Value = "Key"
    Dim i As Integer
    For i = 1 To UBound(headers)
        ws.Cells(1, i + 1).Value = headers(i)
    Next i
    
    ' Write data
    Dim row As Long
    row = 2
    Dim key As Variant
    Dim col As Integer
    
    For Each key In dict.Keys
        ws.Cells(row, 1).Value = key
        For i = 1 To UBound(headers)
            ws.Cells(row, i + 1).Value = dict(key)(headers(i))
        Next i
        row = row + 1
    Next key
    
    ' Auto-fit columns for better readability
    ws.UsedRange.Columns.AutoFit
End Sub
